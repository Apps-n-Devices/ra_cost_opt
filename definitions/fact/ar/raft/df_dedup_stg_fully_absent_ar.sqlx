config {
    type: "table",
    dependencies: "df_unnest_stg_fully_absent_ar"
}

WITH stg_unnest_deduped AS (
  SELECT stg_unnest.*
    , ROW_NUMBER()
      OVER (
        PARTITION BY 
          stg_unnest.assessment_id
          , stg_unnest.study_circle_id
        ORDER BY stg_unnest.ts ASC
      ) AS row_num
  FROM dataform.df_unnest_stg_fully_absent_ar stg_unnest
  LEFT JOIN `dataform.fact_fully_absent_ar` fact_ar 
    ON stg_unnest.assessment_id = fact_ar.assessment_id
    AND stg_unnest.study_circle_id = fact_ar.study_circle_id
  WHERE fact_ar.assessment_id IS NULL --remove duplication with fact_ar table
)
SELECT *
FROM stg_unnest_deduped
WHERE row_num = 1 
